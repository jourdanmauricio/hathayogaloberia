---
const BACKEND = import.meta.env.BACKEND;
const URL = import.meta.env.URL;
---

<div class="w-full sm:w-1/2">
  <div
    id="response-contact-form"
    class="flex-col justify-center items-center h-full hidden"
  >
    <p
      id="form-contact-result"
      class="text-xl font-semibold"
    >
      Mensaje enviado!
    </p>
    <p
      id="contact-message"
      class="mt-4"
    >
      En breve nos pondremos en contacto.
    </p>
    <p>Muchas gracias.</p>
  </div>

  <form
    class="flex flex-col gap-2 px-4 lg:px-8 w-full pt-4"
    id="contact-form"
    novalidate
  >
    <!-- NAME -->
    <div>
      <label
        for="name"
        class="block text-sm font-medium text-gray-900"
        >Nombre</label
      >
      <div class="relative">
        <div
          class="absolute -top-6 inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none"
        >
          <svg
            class="w-4 h-4 text-gray-500"
            aria-hidden="true"
            xmlns="http://www.w3.org/2000/svg"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              d="M10 0a10 10 0 1 0 10 10A10.011 10.011 0 0 0 10 0Zm0 5a3 3 0 1 1 0 6 3 3 0 0 1 0-6Zm0 13a8.949 8.949 0 0 1-4.951-1.488A3.987 3.987 0 0 1 9 13h2a3.987 3.987 0 0 1 3.951 3.512A8.949 8.949 0 0 1 10 18Z"
            ></path>
          </svg>
        </div>
        <input
          type="text"
          id="name"
          name="name"
          class="border text-sm rounded-lg block w-full pl-10 p-2 bg-gray-200 border-gray-600 placeholder-gray-500 text-slate-900 focus:ring-blue-500 focus:border-blue-500"
          data-pattern="^[A-Za-z ñáéíóúÑÁÉÍÓÚ]{0,150}$"
          data-error="El nombre no es válido"
          placeholder="Nombre"
          required
        />
        <span class="text-sm text-red-500 transition-opacity opacity-0"
          >Error</span
        >
      </div>
    </div>

    <!-- EMAIL -->
    <div>
      <label
        for="email"
        class="block text-sm font-medium text-gray-900"
        >Email</label
      >
      <div class="relative">
        <div
          class="absolute -top-6 inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none"
        >
          <svg
            class="w-4 h-4 text-gray-500"
            aria-hidden="true"
            xmlns="http://www.w3.org/2000/svg"
            fill="currentColor"
            viewBox="0 0 20 16"
          >
            <path
              d="m10.036 8.278 9.258-7.79A1.979 1.979 0 0 0 18 0H2A1.987 1.987 0 0 0 .641.541l9.395 7.737Z"
            ></path>
            <path
              d="M11.241 9.817c-.36.275-.801.425-1.255.427-.428 0-.845-.138-1.187-.395L0 2.6V14a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V2.5l-8.759 7.317Z"
            ></path>
          </svg>
        </div>
        <input
          type="text"
          id="email"
          name="email"
          class="border text-sm rounded-lg block w-full pl-10 p-2 bg-gray-200 border-gray-600 placeholder-gray-500 text-slate-900 focus:ring-blue-500 focus:border-blue-500"
          data-pattern="^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$"
          data-error="Email inválido"
          placeholder="name@email.com"
        />
        <span class="text-sm text-red-500 transition-opacity opacity-0"
          >Error</span
        >
      </div>
    </div>

    <!-- PHONE -->
    <div>
      <label
        for="phone"
        class="block text-sm font-medium text-gray-900"
        >Teléfono</label
      >
      <div class="relative">
        <div
          class="absolute -top-6 inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none"
        >
          <svg
            class="w-4 h-4 text-gray-500"
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            fill="currentColor"
            class="bi bi-telephone-fill"
            viewBox="0 0 16 16"
          >
            <path
              fill-rule="evenodd"
              d="M1.885.511a1.745 1.745 0 0 1 2.61.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.678.678 0 0 0 .178.643l2.457 2.457a.678.678 0 0 0 .644.178l2.189-.547a1.745 1.745 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.634 18.634 0 0 1-7.01-4.42 18.634 18.634 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877L1.885.511z"
            ></path>
          </svg>
        </div>
        <input
          type="text"
          id="phone"
          name="phone"
          class="border text-sm rounded-lg block w-full pl-10 p-2 bg-gray-200 border-gray-600 placeholder-gray-500 text-slate-900 focus:ring-blue-500 focus:border-blue-500"
          data-pattern="^[0-9 ()]{7,15}$"
          data-error="Teléfono inválido"
          placeholder="(02262) 444 xxx"
          required
        />
        <span class="text-sm text-red-500 transition-opacity opacity-0"
          >Error</span
        >
      </div>
    </div>

    <!-- COMENTARIO -->
    <div class="flex flex-col w-full">
      <label
        class="text-sm font-medium text-gray-900"
        for="comment"
        >Mensaje
      </label>
      <textarea
        id="comment"
        name="comment"
        rows="4"
        class="border text-sm rounded-lg block w-full pl-2 p-2 bg-gray-200 border-gray-600 placeholder-gray-500 text-slate-900 focus:ring-blue-500 focus:border-blue-500"
        data-pattern="^[a-zA-Z0-9 ÑñÁÉÍÓÚáéíóú]{3,255}$"
        data-error="Ingrese letras o números"
        placeholder="Mensaje"
        required
      ></textarea>
      <span class="text-sm text-red-500 transition-opacity opacity-0"
        >Error</span
      >
    </div>
    <button
      class="mt-6 p-2 px-4 h-10 bg-primary text-white rounded w-full flex items-center justify-center"
      ><span id="send-btn">Enviar</span></button
    >
  </form>
</div>

<style>
  .spinner-btn {
    pointer-events: none;
    width: 20px;
    height: 20px;
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spinner 1s ease-out infinite;
  }

  @keyframes spinner {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
</style>

<script define:vars={{ BACKEND, URL }}>
const sendBtn = document.getElementById( 'send-btn' );

const contactForm = document.getElementById( 'contact-form' );
contactForm.addEventListener( 'submit', ( e ) => sendform( e ) );

async function sendform( e ) {
  e.preventDefault();
  const fieldsToValidate = document
    .getElementById( e.target.id )
    .querySelectorAll( '[required], [data-pattern]' );

  let error = false;
  for ( let i = 0; i < fieldsToValidate.length; i++ ) {
    const field = fieldsToValidate[i];
    const spanError = field.nextSibling;
    spanError.classList.add( 'opacity-0' );
    if ( field.hasAttribute( 'required' ) && field.value.trim().length === 0 ) {
      spanError.textContent = 'Requerido';
      spanError.classList.remove( 'opacity-0' );
      spanError.classList.add( 'opacity-1' );
      error = true;
    }
    if (
      field.value.trim().length > 0 &&
      field.hasAttribute( 'data-pattern' )
    ) {
      let regex = new RegExp( field.dataset.pattern );
      if ( regex.exec( field.value ) === null ) {
        spanError.textContent = field.dataset.error;
        spanError.classList.remove( 'opacity-0' );
        spanError.classList.add( 'opacity-1' );
        error = true;
      }
    }
  }
  if ( error ) return error;

  const data = Object.fromEntries( new FormData( e.target ) );
  data.url = URL;
  const responseContactForm = document.getElementById(
    'response-contact-form'
  );
  const formContactResult = document.getElementById( 'form-contact-result' );
  const contactMessage = document.getElementById( 'contact-message' );

  try {
    sendBtn.innerHTML = '<div></div>';
    sendBtn.classList.add( 'spinner-btn' );
    const response = await fetch( `${BACKEND}/contacts`, {
      method: 'POST',
      body: JSON.stringify( data ),
      headers: { 'Content-Type': 'application/json' },
    } );

    if ( response.ok === false ) throw 'Error';
  } catch ( err ) {
    formContactResult.textContent = 'Error enviando el mensaje';
    contactMessage.textContent = 'Intentelo nuevamente.';
  } finally {
    responseContactForm.classList.add( 'flex' );
    responseContactForm.classList.remove( 'hidden' );
    contactForm.classList.add( 'hidden' );
    contactForm.classList.remove( 'flex' );
  }
}
</script>